-- _G.basicshop = {
-- 	[1] = {
-- 		name = "pets",
-- 		[1] = {name = "ratingpoints_1", price = {rp = 250}, itemname = "item_pet_RDA_simple_1", rarity = "#00ff48", text_color = "#00ff48", type = "pet", currency = "mmrpoints"},
-- 		[2] = {name = "ratingpoints_2", price = {rp = 350}, itemname = "item_pet_RDA_simple_2", rarity = "#00ff48", text_color = "#00ff48", type = "pet", currency = "mmrpoints"},
-- 		[3] = {name = "ratingpoints_3", price = {rp = 450}, itemname = "item_pet_RDA_simple_3", rarity = "#00ff48", text_color = "#00ff48", type = "pet", currency = "mmrpoints"},
-- 		[4] = {name = "pet_15", price = {don = 50}, itemname = "item_pet_RDA_mana_regen", rarity = "#0044ff", text_color = "#0044ff", type = "pet"},
-- 		[5] = {name = "pet_13", price = {don = 50}, itemname = "item_pet_RDA_hp_com", rarity = "#0044ff", text_color = "#0044ff", type = "pet"},
-- 		[6] = {name = "pet_14", price = {don = 50}, itemname = "item_pet_RDA_dmg_com", rarity = "#0044ff", text_color = "#0044ff", type = "pet"},
-- 		[7] = {name = "pet_5", price = {don = 100}, itemname = "item_pet_RDA_total_dmg", rarity = "#ffa600", text_color = "#ffa600", type = "pet"},
-- 		[8] = {name = "pet_6", price = {don = 100}, itemname = "item_pet_RDA_int", rarity = "#ffa600", text_color = "#ffa600", type = "pet"},
-- 		[9] = {name = "pet_7", price = {don = 100}, itemname = "item_pet_RDA_str", rarity = "#ffa600", text_color = "#ffa600", type = "pet"},
-- 		[10] = {name = "pet_8", price = {don = 100}, itemname = "item_pet_RDA_agi", rarity = "#ffa600", text_color = "#ffa600", type = "pet"},
-- 		[11] = {name = "pet_9", price = {don = 100}, itemname = "item_pet_RDA_heal", rarity = "#ffa600", text_color = "#ffa600", type = "pet"},
-- 		[12] = {name = "pet_1", price = {don = 150}, itemname = "item_pet_RDA_dmg", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[13] = {name = "pet_2", price = {don = 150}, itemname = "item_pet_RDA_hp", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[14] = {name = "pet_3", price = {don = 150}, itemname = "item_pet_RDA_fast", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[15] = {name = "pet_4", price = {don = 150}, itemname = "item_pet_RDA_cleave", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[16] = {name = "pet_10", price = {don = 150}, itemname = "item_pet_RDA_block", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[17] = {name = "pet_11", price = {don = 150}, itemname = "item_pet_RDA_all_dmg_amp", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 		[18] = {name = "pet_12", price = {don = 150}, itemname = "item_pet_RDA_gold", rarity = "#d400ff", text_color = "#d400ff", type = "pet"},
-- 	},
-- 	[2] = {
-- 		name = "consumables",
-- 		[1] = {name = "scroll_1", price = {don = 5}, itemname = "item_armor_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[2] = {name = "scroll_2", price = {don = 5}, itemname = "item_base_damage_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[3] = {name = "scroll_3", price = {don = 5}, itemname = "item_expiriance_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[4] = {name = "scroll_4", price = {don = 5}, itemname = "item_move_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[5] = {name = "scroll_5", price = {don = 5}, itemname = "item_attack_speed_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[6] = {name = "scroll_6", price = {don = 5}, itemname = "item_hp_aura", rarity = "gold", type = "consumabl", combinable = true},
-- 		[7] = {name = "scroll_7", price = {don = 2}, itemname = "item_up_ability_tower", rarity = "gold", type = "consumabl", combinable = true},
-- 		[8] = {name = "scroll_8", price = {don = 4}, itemname = "item_up_ability_tower2", rarity = "gold", type = "consumabl", combinable = true},
-- 		[9] = {name = "scroll_9", price = {don = 6}, itemname = "item_up_ability_tower3", rarity = "gold", type = "consumabl", combinable = true},
-- 		[10] = {name = "scroll_10", price = {don = 8}, itemname = "item_up_ability_tower4", rarity = "gold", type = "consumabl", combinable = true},
-- 		[11] = {name = "scroll_11", price = {don = 2}, itemname = "item_ticket", rarity = "gold", type = "consumabl", combinable = true},
-- 		[12] = {name = "scroll_12", price = {don = 10}, itemname = "item_boss_summon", rarity = "gold", type = "consumabl", combinable = true},
-- 		[13] = {name = "other_1", price = {don = 5}, itemname = "item_str", rarity = "red", combinable = true},
-- 		[14] = {name = "other_2", price = {don = 5}, itemname = "item_agi", rarity = "green", combinable = true},
-- 		[15] = {name = "other_3", price = {don = 5}, itemname = "item_int", rarity = "blue", combinable = true},
-- 		[16] = {name = "other_4", price = {don = 15}, itemname = "item_tree_gold", rarity = "gold", combinable = true},
-- 		[17] = {name = "other_8", price = {don = 30}, itemname = "item_tower_protection", rarity = "gold", combinable = true},
-- 	},
-- 	[3] = {
-- 		name = "effects",
-- 		[1] = {name = "effect_7", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef7.png", type = "effect"},
-- 		[2] = {name = "effect_8", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef8.png", type = "effect"},
-- 		[3] = {name = "effect_23", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef23.png", type = "effect"},
-- 		[4] = {name = "effect_24", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef24.png", type = "effect"},
-- 		[5] = {name = "effect_22", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef22.png", type = "effect"},
-- 		[6] = {name = "effect_9", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef9.png", type = "effect"},
-- 		[7] = {name = "effect_10", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef10.png", type = "effect"},
-- 		[8] = {name = "effect_13", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef13.png", type = "effect"},
-- 		[9] = {name = "effect_14", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef14.png", type = "effect"},
-- 		[10] = {name = "effect_15", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef15.png", type = "effect"},
-- 		[11] = {name = "effect_6", price = {don = 10}, rarity = "white", image = "images/custom_game/DonateShop/items/ef6.png", type = "effect"},
-- 		[12] = {name = "effect_11", price = {don = 15}, rarity = "white", image = "images/custom_game/DonateShop/items/ef11.png", type = "effect"},
-- 		[13] = {name = "effect_18", price = {don = 15}, rarity = "white", image = "images/custom_game/DonateShop/items/ef18.png", type = "effect"},
-- 		[14] = {name = "effect_19", price = {don = 15}, rarity = "white", image = "images/custom_game/DonateShop/items/ef19.png", type = "effect"},
-- 		[15] = {name = "effect_20", price = {don = 15}, rarity = "white", image = "images/custom_game/DonateShop/items/ef20.png", type = "effect"},
-- 		[16] = {name = "effect_21", price = {don = 15}, rarity = "white", image = "images/custom_game/DonateShop/items/ef21.png", type = "effect"},
-- 		[17] = {name = "effect_1", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef1.png", type = "effect"},
-- 		[18] = {name = "effect_12", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef12.png", type = "effect"},
-- 		[19] = {name = "effect_16", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef16.png", type = "effect"},
-- 		[20] = {name = "effect_17", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef17.png", type = "effect"},
-- 		[21] = {name = "effect_2", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef2.png", type = "effect"},
-- 		[22] = {name = "effect_3", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef3.png", type = "effect"},
-- 		[23] = {name = "effect_4", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef4.png", type = "effect"},
-- 		[24] = {name = "effect_5", price = {don = 25}, rarity = "white", image = "images/custom_game/DonateShop/items/ef5.png", type = "effect"},
-- 	},
-- 	[4] = {
-- 		name = "other",
-- 		[1] = {name = "other_10", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/Axe.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_axe",},
-- 		[2] = {name = "other_11", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/bb.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_bristleback",},
-- 		[3] = {name = "other_12", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/cent.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_centaur",},
-- 		[4] = {name = "other_13", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/dk.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_dragon_knight",},
-- 		[5] = {name = "other_14", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/io.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_wisp",},
-- 		[6] = {name = "other_15", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/mars.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_mars",},
-- 		[7] = {name = "other_16", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/sk.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_sand_king",},
-- 		[8] = {name = "other_17", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/sven.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_sven",},
-- 		[9] = {name = "other_18", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/trent.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_treant",},
-- 		[10] = {name = "other_19", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/wk.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_skeleton_king",},
-- 		[11] = {name = "other_20", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/arc.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_arc_warden",},
-- 		[12] = {name = "other_21", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/drowjpg.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_drow_ranger",},
-- 		[13] = {name = "other_22", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/jugg.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_juggernaut",},
-- 		[14] = {name = "other_23", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/luna.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_luna",},
-- 		[15] = {name = "other_24", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/pa.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_phantom_assassin",},
-- 		[16] = {name = "other_25", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/sf.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_nevermore",},
-- 		[17] = {name = "other_26", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/slark.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_slark",},
-- 		[18] = {name = "other_27", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/sniper.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_sniper",},
-- 		[19] = {name = "other_28", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/spectre.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_spectre",},
-- 		[20] = {name = "other_29", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/terror.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_terrorblade",},
-- 		[21] = {name = "other_30", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/dazzle.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_dazzle",},
-- 		[22] = {name = "other_31", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/lina.png", rarity = "gold", type = "talant", hero = "npc_dota_hero_lina",},
-- 		[23] = {name = "other_32", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/encha.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_enchantress",},
-- 		[24] = {name = "other_33", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/lion.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_lion",},
-- 		[25] = {name = "other_34", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/pugna.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_pugna",},
-- 		[26] = {name = "other_35", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/ss.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_shadow_shaman",},
-- 		[27] = {name = "other_36", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/tinker.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_tinker",},
-- 		[28] = {name = "other_37", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/werlock.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_warlock",},
-- 		[29] = {name = "other_38", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/wr.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_windrunner",},
-- 		[30] = {name = "other_39", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/zeus.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_zuus",},
-- 		[31] = {name = "other_40", price = {don = 200, rp = 1000}, image = "images/custom_game/DonateShop/heros/demusa.jpg", rarity = "gold", type = "talant", hero = "npc_dota_hero_medusa",},
-- 	},
-- 	[5] = {
-- 		name = "gems",
-- 		[1] = {name = "gem_1_1000", price = {don = 250, rp = 1000}, image = "images/custom_game/smithy/purple_gem.png", rarity = "#00ff48", text_color = "#00ff48", type = "gem", give = 1000, gem_type = 1, combinable = true},
-- 		[2] = {name = "gem_2_1000", price = {don = 250, rp = 1000}, image = "images/custom_game/smithy/blue_gem.png", rarity = "#00ff48", text_color = "#00ff48", type = "gem", give = 1000, gem_type = 2, combinable = true},
-- 		[3] = {name = "gem_3_1000", price = {don = 250, rp = 1000}, image = "images/custom_game/smithy/orange_gem.png", rarity = "#00ff48", text_color = "#00ff48", type = "gem", give = 1000, gem_type = 3, combinable = true},
-- 		[4] = {name = "gem_4_1000", price = {don = 250, rp = 1000}, image = "images/custom_game/smithy/red_gem.png", rarity = "#00ff48", text_color = "#00ff48", type = "gem", give = 1000, gem_type = 4, combinable = true},
-- 		[5] = {name = "gem_5_1000", price = {don = 250, rp = 1000}, image = "images/custom_game/smithy/green_gem.png", rarity = "#00ff48", text_color = "#00ff48", type = "gem", give = 1000, gem_type = 5, combinable = true},
-- 		[6] = {name = "gem_random_1", price = {don = 250, rp = 1000}, image = "images/custom_game/DonateShop/loot-boxes-problem-gambling.png", rarity = "#00ff48", text_color = "#00ff48", type = "loot-box", loot = 1, combinable = true},
-- 	}
-- }
-- local loot_box_info = {
-- 	[1] = {{name = 'gem_1_1000', chance = 20},{name = 'gem_2_1000', chance = 20},{name = 'gem_3_1000', chance = 20},{name = 'gem_4_1000', chance = 20},{name = 'gem_5_1000', chance = 20}},
-- }
_G.basicshop = {
    [1] = {
        name = 'tab_1',
        [1] = {panorama_name = 'panorama_item_1', name = "item_1", price = {don = 50, rp = 100}, itemname = "item_book_of_strength", rarity = "#0044ff", text_color = "#0044ff", type='item', combinable = true, consumabl = true},
		[2] = {panorama_name = 'panorama_item_2', name = "item_2", price = {don = 50}, itemname = "item_key", rarity = "#0044ff", text_color = "#0044ff", type='item'},
		[3] = {panorama_name = 'panorama_item_3', name = "item_3", price = {don = 50}, itemname = "item_pet_RDA_dmg_com", rarity = "#0044ff", text_color = "#0044ff", type='item'},
		[4] = {panorama_name = 'panorama_item_4', name = "item_4", price = {don = 100}, itemname = "item_pet_RDA_total_dmg", rarity = "#ffa600", text_color = "#ffa600", type='item'},
    }
}
if Shop == nil then
    _G.Shop = class({})
end

function Shop:init()
	Shop.pShop = {}
    CustomGameEventManager:RegisterListener("giveItem", Dynamic_Wrap( Shop, 'giveItem' ))
	CustomGameEventManager:RegisterListener("buyItem", Dynamic_Wrap( Shop, 'buyItem' ))
    CustomGameEventManager:RegisterListener("takeOffEffect", Dynamic_Wrap( Shop, 'takeOffEffect' ))
    CustomGameEventManager:RegisterListener("return_item", Dynamic_Wrap( Shop, 'return_item' ))
	ListenToGameEvent("player_reconnected", Dynamic_Wrap( Shop, 'OnPlayerReconnected' ), self)
	ListenToGameEvent( 'game_rules_state_change', Dynamic_Wrap( Shop, 'OnGameRulesStateChange'), self)
end

function Shop:return_item(t)
    --print('Shop:return_item')
    local i = tonumber(t.i)
    local n = tonumber(t.n)
    local obj = Shop.pShop[t.PlayerID][i][n]
    local item_name = obj.itemname
    local hero = PlayerResource:GetSelectedHeroEntity(t.PlayerID)
    --print(item_name)
    if item_name ~= nil and hero then
        local FindItem = hero:FindItemInInventory(item_name)
        if FindItem then
            local car = FindItem:GetCurrentCharges()
            local add = car
            if add == 0 then add = 1 end
            --print(car)
            hero:RemoveItem(FindItem)
            Shop.pShop[t.PlayerID][i][n]['status'] = 'taik'
            Shop.pShop[t.PlayerID][i][n]['now'] = tonumber(Shop.pShop[t.PlayerID][i][n]['now']) + add
            CustomGameEventManager:Send_ServerToPlayer( PlayerResource:GetPlayer( t.PlayerID ), "return_item_js", {i = i, n = n, car = add} )
        end
    end
end

function Shop:OnGameRulesStateChange(keys)
    local game_state = GameRules:State_Get()
    if game_state == DOTA_GAMERULES_STATE_CUSTOM_GAME_SETUP then
        Shop:get_db_info()
    elseif GameRules:State_Get() == DOTA_GAMERULES_STATE_PRE_GAME then
		Timers:CreateTimer(2, function() 
			for i = 0 , PlayerResource:GetPlayerCount() do
				if PlayerResource:IsValidPlayer(i) then
					--print("OnGameRulesStateChange GetPlayerCount i=",i)
					local sid = PlayerResource:GetSteamAccountID(i)
					--print("OnGameRulesStateChange GetPlayerCount sid=",sid)
					CustomGameEventManager:Send_ServerToPlayer( PlayerResource:GetPlayer( i ), "initShop", Shop.pShop[i] )
				end
			end
		end)
	end
end

function Shop:get_db_info()
    local url = 'http://62.109.7.81/boss_survival.php?action=init'
    local arr = {}
    for i = 0 , PlayerResource:GetPlayerCount() do
        if PlayerResource:IsValidPlayer(i) then
            arr[i] = {
                sid = PlayerResource:GetSteamAccountID(i),
                name = PlayerResource:GetPlayerName(i),            
            }
        end
    end
    arr = json.encode(arr)
    --print(arr)
	local req = CreateHTTPRequestScriptVM( "POST", url )
	req:SetHTTPRequestGetOrPostParameter('arr',arr)
	req:SetHTTPRequestAbsoluteTimeoutMS(100000)
    --print(arr)
	req:Send(function(res)
		if res.StatusCode == 200 and res.Body ~= nil then
            _G.SHOP = json.decode(res.Body)
			Shop:createShop()
        end
	end)
end

function Shop:OnPlayerReconnected(keys)
	local sid = PlayerResource:GetSteamAccountID(keys.PlayerID)
	if GameRules:State_Get() >= DOTA_GAMERULES_STATE_PRE_GAME then
		Timers:CreateTimer(2, function() 
			local sid = PlayerResource:GetSteamAccountID( keys.PlayerID )
			CustomGameEventManager:Send_ServerToPlayer( PlayerResource:GetPlayer( keys.PlayerID ), "initShop", Shop.pShop[keys.PlayerID] )
		end)
	end
end


function Shop:createShop()

	if SHOP then
		for i = 0 , PlayerResource:GetPlayerCount() do --
			if PlayerResource:IsValidPlayer(i) then -- 
				local sid = PlayerResource:GetSteamAccountID(i)
				local arr = {}
				for sKey, sValue in pairs(basicshop) do
					if type(sValue) == 'table' then
						arr[sKey] = {}
						for oKey, oValue in pairs(sValue) do
							arr[sKey][oKey] = {}
							if type(oValue) == 'table' then

								for pKey, pValue in pairs(oValue) do
									arr[sKey][oKey][pKey] = pValue
								end
								
								if SHOP[i+1][oValue.name] then
									arr[sKey][oKey].onStart = tonumber(SHOP[i+1][oValue.name])
									arr[sKey][oKey].now = tonumber(SHOP[i+1][oValue.name])
									if arr[sKey][oKey].consumabl then
										arr[sKey][oKey].status = 'consumabl'
									elseif tonumber(SHOP[i+1][oValue.name]) > 0 then
										if arr[sKey][oKey].type == "talant" then
											arr[sKey][oKey].status = 'active'
										else
											arr[sKey][oKey].status = 'taik'
										end
									else
										arr[sKey][oKey].status = 'buy'
									end
								else
									arr[sKey][oKey].onStart = 0
									arr[sKey][oKey].now = 0
									if arr[sKey][oKey].consumabl then
										arr[sKey][oKey].status = 'consumabl'
									else
										arr[sKey][oKey].status = 'buy'
									end
								end
							elseif type(oValue) == 'string' then
								arr[sKey][oKey] = oValue
							end
						end
					end
				end
				if SHOP[i+1].coins then
					arr.coins = SHOP[i+1].coins
				else
					arr.coins = 0
				end
				if SHOP[i+1].mmrpoints then
					arr.mmrpoints = SHOP[i+1].mmrpoints
				else
					arr.mmrpoints = 0
				end
				Shop.pShop[i] = arr
			end
		end
		
		for i = 0, 4 do
            Timers:CreateTimer(function()
                if PlayerResource:GetPlayer(i) == nil then
                    return nil
                end
                if PlayerResource:HasSelectedHero(i) then
                    local heroName = PlayerResource:GetSelectedHeroName(i)
                    talants:pickinfo(i)
                    return nil
                else
                    --print(PlayerResource:HasSelectedHero(i))
                end
                return 1.0
            end)
        end
	else
		--print("============================")
		--print("ERROR: _G.SHOP not exist")
		--print("CREATE SHOP FAILED")
		--peint("============================")
	end
end

function Shop:giveItem(t)
	local pid = t.PlayerID
	local sid = PlayerResource:GetSteamAccountID(pid)
	--print("giveItem pid=",pid)
	--print("giveItem sid=",sid)
	local categoryKey = t.i
	local productKey = t.n
	if tonumber(Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['now']) <= 0 or Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['status'] == "issued" then
		return
	end
	--print(Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['now'])
	Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['now'] = tonumber(Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['now']) - 1
	if Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['now'] == 0 and Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['status'] ~= "consumabl" then 
		Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['status'] = 'issued'
	end
	if Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].type == "effect" then
		LinkLuaModifier( "modifier_" .. Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].name, "effects/" .. Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].name, LUA_MODIFIER_MOTION_NONE )
		local hero = PlayerResource:GetSelectedHeroEntity( pid )
		hero:AddNewModifier( hero, nil, "modifier_" .. Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].name, {} )
		Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)]['status'] = 'takeoff'
	else
		local player = PlayerResource:GetSelectedHeroEntity(pid)
		local spawnPoint = player:GetAbsOrigin()
		player:AddItemByName(Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].itemname)
	end
	if Shop.pShop[pid][tonumber(categoryKey)][tonumber(productKey)].type == 'pet' then
		for q,w in pairs(Shop.pShop[pid]) do
			if type(w) == 'table' then
				for e,r in pairs(w) do
					if type(r) == 'table' and r.type == "pet" then
						Shop.pShop[pid][q][e]['status'] = 'issued'
					end
				end
			end
		end
	end
end

function Shop:takeOffEffect(t)
	local pid = t.PlayerID
	Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['now'] = tonumber(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['now']) + 1

    local hero = PlayerResource:GetSelectedHeroEntity( pid )
    hero:RemoveModifierByName( "modifier_" .. Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)].name)

end


function Shop:buyItem(t)
	local pid = t.PlayerID
	local i = tonumber(t.i)
	local n = tonumber(t.n)
	local shop_type = Shop.pShop[pid][i][n]["type"]
	--print('currency=',t.currency)
	if t.currency == 1 and Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['rp'] and tonumber(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['rp'] * t.amountBuy) > tonumber(Shop.pShop[pid].mmrpoints) then
		return
	elseif t.currency == 0 and Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['don'] and tonumber(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['don']*t.amountBuy) > tonumber(Shop.pShop[pid].coins) then
		return
	end
	if Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]["type"] ~= "gem" and Shop.pShop[pid][i][n]["type"] ~= "loot-box" then
		Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['now'] = tonumber(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)].now) + t.amountBuy
		Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['onStart'] = tonumber(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['onStart']) + t.amountBuy
	end
	if t.currency == 1 then
		Shop.pShop[pid].mmrpoints = Shop.pShop[pid].mmrpoints - Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['rp'] * t.amountBuy
	else
		Shop.pShop[pid].coins = Shop.pShop[pid].coins - Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]['price']['don'] * t.amountBuy
	end
	if true then --DataBase:isCheatOn() == false
		local sql_name = {}
		local give = {}
		local currency = 'don'
		if t.currency == 1 then currency = 'rp' end
		local price = Shop.pShop[pid][i][n]['price'][currency]
		
		if Shop.pShop[pid][i][n]["type"] == "gem" then
			local gem_name = 'gem_' .. Shop.pShop[pid][i][n]['gem_type']
			sql_name[gem_name] = t.amountBuy
			give[gem_name] = Shop.pShop[pid][i][n]['give']
		elseif Shop.pShop[pid][i][n]["type"] == "loot-box" then
			-- loot box 
			for z = 1, t.amountBuy do
				local randomInt = RandomInt(1,100)
				local ds = 0
				local slt = nil
				for g,m in pairs(loot_box_info[Shop.pShop[pid][i][n]['loot']]) do
					--key value
					local dsc = ds + 1
					ds = ds + m['chance']
					if randomInt >= dsc and randomInt <= ds then
						slt = g
						break
					end
				end
				-- print(randomInt)
				-- print(slt)
				local loot_name = loot_box_info[Shop.pShop[pid][i][n]['loot']][slt]['name']
				for k1,v1 in pairs(_G.basicshop) do
					for k2,v2 in pairs(v1) do
						if type(v2) == 'table' and v2.name == loot_name then
							-- DeepPrintTable(v2)
							if v2.type == 'gem' then
								local gem_name = 'gem_' .. v2['gem_type']
								if sql_name[gem_name] then
									sql_name[gem_name] = sql_name[gem_name] + 1
								else
									sql_name[gem_name] = 1
								end
								give[gem_name] = v2['give']
							end
						end
					end
				end
			end
		else
			sql_name[Shop.pShop[pid][i][n].name] = t.amountBuy
			give[Shop.pShop[pid][i][n].name] = 1
		end
		

		for pi = 1, 5 do
			if sql_name['gem_'..pi] and give['gem_'..pi] then
				CustomShop:AddGems(t.PlayerID, {
					[pi] = give['gem_'..pi] * sql_name['gem_'..pi]
				}, not DataBase:IsCheatMode())
			end
		end
		

		if shop_type == "talant" then
			talants:sendServer({PlayerID = pid, changename = "cout", value = 2, changetype = "set", chartype = "int", win_lose = nil, heroname = Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]["hero"]})
			if Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]["hero"] == PlayerResource:GetSelectedHeroName(pid) then
				local tab = CustomNetTables:GetTableValue("talants", tostring(pid))
				tab["cout"] = 2
				progress[t.PlayerID] = tab
				CustomNetTables:SetTableValue("talants", tostring(pid), tab)
			end
		elseif shop_type == "gem" then
			--print(Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]["give"],' ',t.amountBuy,' ',Shop.pShop[pid][tonumber(t.i)][tonumber(t.n)]["give"] * t.amountBuy)
			CustomShop:AddGems(t.PlayerID, {
				[Shop.pShop[pid][i][n]["gem_type"]] = Shop.pShop[pid][i][n]["give"] * t.amountBuy
			}, false )
		end
		Shop:buyRequest({PlayerID = t.PlayerID, name = sql_name, give = give, price = price, amount = t.amountBuy, currency = currency})
		CustomNetTables:SetTableValue("shopinfo", tostring(pid), {coins = Shop.pShop[pid]["coins"], mmrpoints = Shop.pShop[pid]["mmrpoints"]})
	end
end

function Shop:buyRequest(t)
    local url = 'http://62.109.7.81/boss_survival.php?action=buy'
	local arr = {
		sid = PlayerResource:GetSteamAccountID( t.PlayerID ),
		price = t.price,
		currency = t.currency,
		name = t.name,
		give = t.give,
		hero_name = PlayerResource:GetSelectedHeroName(t.PlayerID),
		amount = t.amount,
	}
	local req = CreateHTTPRequestScriptVM( "POST", url )
    arr = json.encode(arr)
    --print(arr)
	req:SetHTTPRequestGetOrPostParameter('arr',arr)
	req:SetHTTPRequestAbsoluteTimeoutMS(100000)
	req:Send(function(res)
		if res.StatusCode == 200 then
			--print(res.Body)
        else 
            --print('!200')
        end
	end)
end

Shop:init()